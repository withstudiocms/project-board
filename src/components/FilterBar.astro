---
interface Props {
  currentState?: string;
  currentType?: string;
  currentLabels?: string[];
  allLabels?: string[];
}

const { 
  currentState = 'open', 
  currentType = 'all',
  currentLabels = [],
  allLabels = []
} = Astro.props;
---

<div class="filters">
  <div class="filter-group">
    <label for="state-filter">State:</label>
    <select id="state-filter" name="state">
      <option value="open" selected={currentState === 'open'}>Open</option>
      <option value="closed" selected={currentState === 'closed'}>Closed</option>
      <option value="all" selected={currentState === 'all'}>All</option>
    </select>
  </div>
  
  <div class="filter-group">
    <label for="type-filter">Type:</label>
    <select id="type-filter" name="type">
      <option value="all" selected={currentType === 'all'}>All</option>
      <option value="issue" selected={currentType === 'issue'}>Issues</option>
      <option value="pr" selected={currentType === 'pr'}>Pull Requests</option>
      <option value="discussion" selected={currentType === 'discussion'}>Discussions</option>
    </select>
  </div>
  
  {allLabels.length > 0 && (
    <div class="filter-group label-filter">
      <label for="label-filter">Labels:</label>
      <div class="label-select-container">
        <div class="label-select" id="label-select">
          <span class="label-placeholder">
            {currentLabels.length === 0 ? 'All labels' : `${currentLabels.length} selected`}
          </span>
          <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
            <path d="M3 5L6 8L9 5H3Z"/>
          </svg>
        </div>
        <div class="label-dropdown" id="label-dropdown">
          <div class="label-search-container">
            <input 
              type="text" 
              class="label-search" 
              id="label-search"
              placeholder="Search labels..."
            />
          </div>
          <div class="label-options" id="label-options">
            {allLabels.map(label => (
              <label class="label-option">
                <input 
                  type="checkbox" 
                  name="labels" 
                  value={label}
                  checked={currentLabels.includes(label)}
                />
                <span class="label-name">{label}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>
  )}
  
  <button type="button" class="filter-button">Apply Filters</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const stateFilter = document.getElementById('state-filter') as HTMLSelectElement;
    const typeFilter = document.getElementById('type-filter') as HTMLSelectElement;
    const filterButton = document.querySelector('.filter-button') as HTMLButtonElement;
    const labelSelect = document.getElementById('label-select');
    const labelDropdown = document.getElementById('label-dropdown');
    const labelSearch = document.getElementById('label-search') as HTMLInputElement;
    const labelOptions = document.getElementById('label-options');
    
    // Toggle label dropdown
    if (labelSelect && labelDropdown) {
      labelSelect.addEventListener('click', (e) => {
        e.stopPropagation();
        labelDropdown.classList.toggle('show');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!labelDropdown.contains(e.target as Node) && e.target !== labelSelect) {
          labelDropdown.classList.remove('show');
        }
      });
      
      // Prevent dropdown from closing when clicking inside
      labelDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
    
    // Label search functionality
    if (labelSearch && labelOptions) {
      labelSearch.addEventListener('input', (e) => {
        const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
        const options = labelOptions.querySelectorAll('.label-option');
        
        options.forEach((option) => {
          const labelName = option.querySelector('.label-name')?.textContent?.toLowerCase() || '';
          if (labelName.includes(searchTerm)) {
            (option as HTMLElement).style.display = '';
          } else {
            (option as HTMLElement).style.display = 'none';
          }
        });
      });
    }
    
    // Update selected count
    if (labelOptions && labelSelect) {
      labelOptions.addEventListener('change', () => {
        const checkedCount = labelOptions.querySelectorAll('input[type="checkbox"]:checked').length;
        const placeholder = labelSelect.querySelector('.label-placeholder');
        if (placeholder) {
          placeholder.textContent = checkedCount === 0 ? 'All labels' : `${checkedCount} selected`;
        }
      });
    }
    
    filterButton.addEventListener('click', () => {
      const params = new URLSearchParams();
      params.set('state', stateFilter.value);
      params.set('type', typeFilter.value);
      
      // Get selected labels
      if (labelOptions) {
        const selectedLabels = Array.from(
          labelOptions.querySelectorAll('input[type="checkbox"]:checked')
        ).map((checkbox) => (checkbox as HTMLInputElement).value);
        
        if (selectedLabels.length > 0) {
          params.set('labels', selectedLabels.join(','));
        }
      }
      
      window.location.href = `/?${params.toString()}`;
    });
  });
</script>

<style>
  .label-filter {
    min-width: 150px;
  }
  
  .label-select-container {
    position: relative;
    width: 100%;
  }
  
  .label-select {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.5rem 1rem 0.5rem 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }
  
  .label-select:hover {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
  }
  
  .label-placeholder {
    flex: 1;
    color: var(--color-text-primary);
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .label-select svg {
    transition: transform 0.2s ease;
    opacity: 0.5;
  }
  
  .label-select:hover svg {
    opacity: 1;
  }
  
  .label-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: var(--bg-primary);
    border: 1px solid var(--border-secondary);
    border-radius: 6px;
    box-shadow: var(--shadow-lg);
    max-height: 320px;
    overflow: hidden;
    display: none;
    z-index: 100;
  }
  
  .label-dropdown.show {
    display: block;
  }
  
  .label-search-container {
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-secondary);
    background: var(--bg-secondary);
  }
  
  .label-search {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-secondary);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--color-text-primary);
    font-size: 0.875rem;
    transition: all 0.2s ease;
  }
  
  .label-search:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
  }
  
  .label-search::placeholder {
    color: var(--color-text-tertiary);
  }
  
  .label-options {
    max-height: 240px;
    overflow-y: auto;
    padding: 0.5rem;
    background: var(--bg-primary);
  }
  
  .label-options::-webkit-scrollbar {
    width: 8px;
  }
  
  .label-options::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 4px;
  }
  
  .label-options::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 4px;
  }
  
  .label-options::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
  }
  
  .label-option {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    transition: all 0.15s ease;
    border-radius: 4px;
    margin-bottom: 0.125rem;
  }
  
  .label-option:hover {
    background: var(--bg-secondary);
  }
  
  .label-option input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--color-primary);
  }
  
  .label-name {
    font-size: 0.875rem;
    color: var(--color-text-primary);
  }
</style>
